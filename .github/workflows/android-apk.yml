name: Android APK Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Decode Firebase google-services.json
      if: ${{ secrets.FIREBASE_GOOGLE_SERVICES_JSON_BASE64 != '' }}
      run: |
        echo "Decoding Firebase configuration..."
        echo "${{ secrets.FIREBASE_GOOGLE_SERVICES_JSON_BASE64 }}" | base64 -d > FenceWiseApp/app/google-services.json
        echo "Firebase configuration decoded successfully"
    
    - name: Use mock google-services.json for Debug build
      if: ${{ secrets.FIREBASE_GOOGLE_SERVICES_JSON_BASE64 == '' }}
      run: |
        echo "Using mock Firebase configuration for Debug build..."
        if [ -f FenceWiseApp/app/google-services.mock.json ]; then
          cp FenceWiseApp/app/google-services.mock.json FenceWiseApp/app/google-services.json
          echo "Mock Firebase configuration copied successfully"
        else
          echo "Warning: Mock google-services.json not found"
        fi
    
    - name: Grant execute permission for gradlew
      run: chmod +x FenceWiseApp/gradlew
    
    - name: Build Debug APK
      run: |
        cd FenceWiseApp
        ./gradlew assembleDebug --stacktrace
    
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: FenceWise_v1.0_debug
        path: FenceWiseApp/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
    
    - name: Build summary
      run: |
        echo "### Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **APK Name:** FenceWise_v1.0_debug" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type:** Debug" >> $GITHUB_STEP_SUMMARY
        echo "- **Java Version:** JDK 17 (Temurin)" >> $GITHUB_STEP_SUMMARY
        echo "- **Gradle Version:** 8.7" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… APK successfully built and uploaded as artifact" >> $GITHUB_STEP_SUMMARY
